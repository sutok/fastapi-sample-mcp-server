# クラス設計書

## 1. 概要

本システムは以下のモジュール構成で実装します：

```
app/
├── api/          # APIルーティング
├── core/         # コアロジック
├── models/       # データモデル
├── services/     # ビジネスロジック
├── repositories/ # データアクセス
└── utils/        # ユーティリティ
```

## 2. モジュール詳細

### 2.1 API モジュール (api/)

#### ReservationController

```python
class ReservationController:
    def __init__(self, reservation_service: ReservationService):
        self.reservation_service = reservation_service

    async def create_reservation(self, data: ReservationCreate) -> Reservation:
        """予約を作成"""
        pass

    async def get_reservations(self, filters: ReservationFilters) -> List[Reservation]:
        """予約一覧を取得"""
        pass

    async def update_reservation(self, id: str, data: ReservationUpdate) -> Reservation:
        """予約を更新"""
        pass

    async def cancel_reservation(self, id: str, reason: str) -> Reservation:
        """予約をキャンセル"""
        pass
```

#### UserController

```python
class UserController:
    def __init__(self, user_service: UserService):
        self.user_service = user_service

    async def create_user(self, data: UserCreate) -> User:
        """ユーザーを作成"""
        pass

    async def get_users(self, filters: UserFilters) -> List[User]:
        """ユーザー一覧を取得"""
        pass

    async def update_user(self, id: str, data: UserUpdate) -> User:
        """ユーザーを更新"""
        pass
```

### 2.2 コアモジュール (core/)

#### Config

```python
class Config:
    """システム設定を管理"""
    APP_NAME: str
    DEBUG: bool
    API_V1_STR: str
    SECRET_KEY: str
    ACCESS_TOKEN_EXPIRE_MINUTES: int
    FIREBASE_CREDENTIALS_PATH: str
```

#### Security

```python
class Security:
    """セキュリティ関連の機能を提供"""
    @staticmethod
    async def verify_token(token: str) -> dict:
        """トークンを検証"""
        pass

    @staticmethod
    async def create_access_token(data: dict) -> str:
        """アクセストークンを生成"""
        pass
```

### 2.3 モデルモジュール (models/)

#### ReservationModel

```python
class ReservationModel(BaseModel):
    """予約モデル"""
    id: str
    user_id: str
    date: datetime
    time_slot: str
    duration: int
    status: str
    notes: Optional[str]
    reception_number: str
    created_at: datetime
    updated_at: datetime
    cancelled_at: Optional[datetime]
    cancel_reason: Optional[str]
    checked_in_at: Optional[datetime]
    completed_at: Optional[datetime]
```

#### UserModel

```python
class UserModel(BaseModel):
    """ユーザーモデル"""
    id: str
    email: str
    display_name: str
    phone_number: str
    role: str
    created_at: datetime
    updated_at: datetime
    last_login_at: datetime
    status: str
    preferences: Dict[str, Any]
```

### 2.4 サービスモジュール (services/)

#### ReservationService

```python
class ReservationService:
    """予約関連のビジネスロジック"""
    def __init__(self, repository: ReservationRepository):
        self.repository = repository

    async def create_reservation(self, data: ReservationCreate) -> Reservation:
        """予約作成のビジネスロジック"""
        pass

    async def validate_reservation(self, data: ReservationCreate) -> bool:
        """予約のバリデーション"""
        pass

    async def calculate_waiting_time(self, reservation: Reservation) -> int:
        """待ち時間の計算"""
        pass
```

#### UserService

```python
class UserService:
    """ユーザー関連のビジネスロジック"""
    def __init__(self, repository: UserRepository):
        self.repository = repository

    async def create_user(self, data: UserCreate) -> User:
        """ユーザー作成のビジネスロジック"""
        pass

    async def validate_user(self, data: UserCreate) -> bool:
        """ユーザーのバリデーション"""
        pass
```

### 2.5 リポジトリモジュール (repositories/)

#### ReservationRepository

```python
class ReservationRepository:
    """予約データのCRUD操作"""
    def __init__(self, db: FirestoreClient):
        self.db = db

    async def create(self, data: Dict) -> Dict:
        """予約データの作成"""
        pass

    async def find_by_id(self, id: str) -> Optional[Dict]:
        """IDによる予約データの取得"""
        pass

    async def update(self, id: str, data: Dict) -> Dict:
        """予約データの更新"""
        pass

    async def delete(self, id: str) -> bool:
        """予約データの削除"""
        pass
```

#### UserRepository

```python
class UserRepository:
    """ユーザーデータのCRUD操作"""
    def __init__(self, db: FirestoreClient):
        self.db = db

    async def create(self, data: Dict) -> Dict:
        """ユーザーデータの作成"""
        pass

    async def find_by_id(self, id: str) -> Optional[Dict]:
        """IDによるユーザーデータの取得"""
        pass

    async def update(self, id: str, data: Dict) -> Dict:
        """ユーザーデータの更新"""
        pass
```

### 2.6 ユーティリティモジュール (utils/)

#### DateTimeUtil

```python
class DateTimeUtil:
    """日時操作ユーティリティ"""
    @staticmethod
    def format_time(time: datetime) -> str:
        """時刻のフォーマット"""
        pass

    @staticmethod
    def is_business_hours(time: datetime) -> bool:
        """営業時間内かどうかを判定"""
        pass
```

#### ValidationUtil

```python
class ValidationUtil:
    """バリデーションユーティリティ"""
    @staticmethod
    def validate_email(email: str) -> bool:
        """メールアドレスのバリデーション"""
        pass

    @staticmethod
    def validate_phone(phone: str) -> bool:
        """電話番号のバリデーション"""
        pass
```

## 3. 依存関係

### 3.1 モジュール間の依存関係

```
Controller → Service → Repository → Database
     ↓          ↓          ↓
   Model      Model      Model
```

### 3.2 依存性注入

- FastAPI の Dependency Injection を使用
- 各レイヤーの依存関係を疎結合に保つ
- テスト時のモック化を容易にする

## 4. エラー処理

### 4.1 カスタム例外

```python
class AppException(Exception):
    """アプリケーション基底例外"""
    pass

class ValidationException(AppException):
    """バリデーション例外"""
    pass

class NotFoundException(AppException):
    """データ未検出例外"""
    pass

class AuthenticationException(AppException):
    """認証例外"""
    pass
```

### 4.2 例外ハンドリング

- グローバルな例外ハンドラーで一括処理
- 適切な HTTP ステータスコードとエラーメッセージを返却
- ログ出力と監視の連携

## 5. インターフェース定義

### 5.1 リポジトリインターフェース

```python
class IRepository(Protocol):
    """リポジトリの基底インターフェース"""
    async def create(self, data: Dict) -> Dict:
        pass

    async def find_by_id(self, id: str) -> Optional[Dict]:
        pass

    async def update(self, id: str, data: Dict) -> Dict:
        pass

    async def delete(self, id: str) -> bool:
        pass
```

### 5.2 サービスインターフェース

```python
class IService(Protocol):
    """サービスの基底インターフェース"""
    async def validate(self, data: Any) -> bool:
        pass

    async def process(self, data: Any) -> Any:
        pass
```
