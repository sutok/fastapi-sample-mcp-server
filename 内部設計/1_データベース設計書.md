# データベース設計書

## 1. データベース概要

### 1.1 使用データベース

- データベース: Cloud Firestore
- 型: NoSQL ドキュメントデータベース
- バージョン: 最新
- 文字コード: UTF-8

### 1.2 コレクション構成

```
firestore/
├── companies/            # 企業情報
├── stores/              # 店舗情報
├── users/               # ユーザー情報
├── reservations/        # 予約情報
├── settings/            # システム設定
├── notifications/       # お知らせ
└── statistics/          # 統計情報
```

## 2. コレクション定義

### 2.1 companies コレクション

```typescript
interface Company {
  id: string; // 企業ID
  company_name: string; // 企業名
  email: string; // メールアドレス
  phone: string; // 電話番号
  createdAt: Timestamp; // 作成日時
  updatedAt: Timestamp; // 更新日時
}
```

### 2.2 stores コレクション

```typescript
interface Branch {
  id: string; // 店舗ID
  company_id: string; // 企業ID（外部キー）
  branch_name: string; // 店舗名
  email: string; // メールアドレス
  phone: string; // 電話番号
  createdAt: Timestamp; // 作成日時
  updatedAt: Timestamp; // 更新日時
}
```

### 2.3 users コレクション

```typescript
interface User {
  id: string; // ユーザーID（Firebase Auth UID）
  company_id: string; // 企業ID（外部キー）
  branch_id: string; // 店舗ID（外部キー）
  email: string; // メールアドレス
  user_name: string; // 表示名
  phone: string; // 電話番号
  role: "system_admin" | "company_admin" | "store_admin" | "staff" | "user"; // 権限
  createdAt: Timestamp; // 作成日時
  updatedAt: Timestamp; // 更新日時
  lastLoginAt: Timestamp; // 最終ログイン日時
  status: "active" | "inactive" | "banned"; // ステータス
  preferences: {
    // ユーザー設定
    language: string; // 言語設定
    notification: boolean; // 通知設定
  };
}
```

### 2.4 reservations コレクション

```typescript
interface Reservation {
  id: string; // 予約ID
  company_id: string; // 企業ID（外部キー）
  branch_id: string; // 店舗ID（外部キー）
  userId: string; // ユーザーID（外部キー）
  date: Timestamp; // 予約日
  timeSlot: string; // 時間枠 (HH:mm形式)
  duration: number; // 予約時間（分）
  status: "confirmed" | "cancelled" | "completed"; // 予約状態
  notes: string; // 備考
  receptionNumber: string; // 受付番号
  createdAt: Timestamp; // 作成日時
  updatedAt: Timestamp; // 更新日時
  cancelledAt?: Timestamp; // キャンセル日時
  cancelReason?: string; // キャンセル理由
  checkedInAt?: Timestamp; // チェックイン時刻
  completedAt?: Timestamp; // 完了時刻
}
```

### 2.5 settings コレクション

```typescript
interface SystemSettings {
  id: string; // 設定ID
  company_id: string; // 企業ID（外部キー）
  branch_id: string; // 店舗ID（外部キー）
  businessHours: {
    // 営業時間
    start: string; // 開始時間 (HH:mm)
    end: string; // 終了時間 (HH:mm)
  };
  timeSlotDuration: number; // 時間枠の単位（分）
  maxReservationsPerUser: number; // ユーザーあたりの最大予約数
  cancellationPolicy: {
    // キャンセルポリシー
    freeUntilHours: number; // 無料キャンセル可能時間
    chargeRate: number; // キャンセル料率
  };
  updatedAt: Timestamp; // 更新日時
  updatedBy: string; // 更新者
}
```

### 2.6 notifications コレクション

```typescript
interface Notification {
  id: string; // 通知ID
  company_id: string; // 企業ID（外部キー）
  branch_id: string; // 店舗ID（外部キー）
  type: "system" | "reservation" | "maintenance"; // 通知種別
  title: string; // タイトル
  content: string; // 内容
  priority: "high" | "normal" | "low"; // 優先度
  startAt: Timestamp; // 表示開始日時
  endAt: Timestamp; // 表示終了日時
  targetUsers: string[]; // 対象ユーザー（空配列の場合は全員）
  createdAt: Timestamp; // 作成日時
  createdBy: string; // 作成者
}
```

### 2.7 statistics コレクション

```typescript
interface DailyStatistics {
  id: string; // 統計ID（YYYYMMDD）
  company_id: string; // 企業ID（外部キー）
  branch_id: string; // 店舗ID（外部キー）
  date: Timestamp; // 対象日
  reservations: {
    // 予約統計
    total: number; // 総予約数
    cancelled: number; // キャンセル数
    completed: number; // 完了数
    noShow: number; // 無断キャンセル数
  };
  timeSlots: {
    // 時間枠別統計
    [key: string]: {
      // HH:mm形式
      reserved: number; // 予約数
      available: number; // 空き数
    };
  };
  updatedAt: Timestamp; // 更新日時
}
```

## 3. インデックス設計

### 3.1 単一フィールドインデックス

- companies

  - company_name
  - createdAt

- stores

  - company_id
  - branch_name
  - createdAt

- users

  - company_id
  - branch_id
  - email
  - role
  - status
  - createdAt

- reservations

  - company_id
  - branch_id
  - userId
  - date
  - status
  - receptionNumber
  - createdAt

- notifications
  - company_id
  - branch_id
  - type
  - priority
  - startAt
  - endAt

### 3.2 複合インデックス

- stores

  - [company_id, branch_name]

- reservations

  - [company_id, branch_id, date, timeSlot, status]
  - [company_id, branch_id, userId, date, status]
  - [company_id, branch_id, date, status, createdAt]

- notifications
  - [company_id, branch_id, type, startAt, endAt]
  - [company_id, branch_id, priority, startAt, endAt]

## 4. セキュリティルール

### 4.1 基本ルール

```typescript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 認証済みユーザーのみアクセス可能
    function isAuthenticated() {
      return request.auth != null;
    }

    // 管理者権限チェック
    function isAdmin() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // スタッフ権限チェック
    function isStaff() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'staff';
    }

    // 自身のデータかチェック
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
  }
}
```

### 4.2 コレクション別ルール

```typescript
// ユーザーコレクション
match /users/{userId} {
  allow read: if isAuthenticated() && (isOwner(userId) || isAdmin() || isStaff());
  allow write: if isAdmin();
  allow update: if isAuthenticated() && isOwner(userId);
}

// 予約コレクション
match /reservations/{reservationId} {
  allow read: if isAuthenticated();
  allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
  allow update: if isAuthenticated() && (
    isOwner(resource.data.userId) || isAdmin() || isStaff()
  );
  allow delete: if isAdmin();
}

// 設定コレクション
match /settings/{settingId} {
  allow read: if isAuthenticated();
  allow write: if isAdmin();
}

// 通知コレクション
match /notifications/{notificationId} {
  allow read: if isAuthenticated();
  allow write: if isAdmin() || isStaff();
}

// 統計コレクション
match /statistics/{statisticId} {
  allow read: if isAuthenticated() && (isAdmin() || isStaff());
  allow write: if isAdmin();
}
```

## 5. バックアップ設定

### 5.1 自動バックアップ

- 頻度: 日次
- 時間: 深夜 3:00
- 保持期間: 30 日
- 保存先: Cloud Storage

### 5.2 手動バックアップ

- 大規模アップデート前
- データ移行前
- 重要な機能追加前

## 6. パフォーマンス最適化

### 6.1 クエリ最適化

- 必要最小限のフィールドのみ取得
- ページネーションの実装
- 適切なバッチ処理の使用

### 6.2 キャッシュ戦略

- 参照頻度の高いデータのキャッシュ
- リアルタイムアップデートの適切な使用
- クライアントサイドキャッシュの活用
