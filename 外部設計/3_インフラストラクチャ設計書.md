# インフラストラクチャ設計書

## 1. サーバー構成

### 1.1 本番環境

- **アプリケーションサーバー**

  - Platform: Google Cloud Run
  - Instances: オートスケール（最小 1、最大 10）
  - Memory: 1GB/instance
  - CPU: 1vCPU/instance
  - Container: Docker

- **データベース**

  - Platform: Cloud Firestore
  - Mode: Native
  - Region: asia-northeast1
  - Backup: 日次

- **キャッシュサーバー**
  - Platform: Redis (Memory Store)
  - Size: 1GB
  - Version: 6.x
  - High Availability: Enabled

### 1.2 開発環境

- **アプリケーションサーバー**

  - Platform: Local Docker
  - Memory: 512MB
  - CPU: 1vCPU

- **データベース**

  - Platform: Firestore Emulator
  - Port: 8080

- **キャッシュサーバー**
  - Platform: Local Redis
  - Port: 6379

## 2. ネットワーク構成

### 2.1 ネットワークアーキテクチャ

```
[Client] → [Cloud Load Balancer] → [Cloud Run] → [Cloud Firestore]
                                              ↘ [Cloud Storage]
                                              ↘ [Memory Store]
```

### 2.2 セキュリティグループ設定

- **外部アクセス**

  - Inbound: HTTPS (443)
  - Source: Any

- **内部アクセス**
  - Inbound: All
  - Source: VPC 内

### 2.3 VPC 設定

- Region: asia-northeast1
- Network Range: 10.0.0.0/16
- Subnets:
  - App: 10.0.1.0/24
  - DB: 10.0.2.0/24
  - Cache: 10.0.3.0/24

## 3. セキュリティ対策

### 3.1 ネットワークセキュリティ

- Cloud Armor（WAF）の導入
- SSL/TLS 証明書の自動管理
- VPC セキュリティポリシー
- DDoS 保護

### 3.2 アプリケーションセキュリティ

- Firebase Authentication
- IAM による権限管理
- セキュリティスキャン
- 脆弱性診断

### 3.3 データセキュリティ

- データ暗号化（保存時）
- 通信暗号化（転送時）
- バックアップ暗号化
- アクセスログ保存

## 4. スケーラビリティ計画

### 4.1 水平スケーリング

- Cloud Run の自動スケーリング
- Load Balancer による負荷分散
- Firestore のスケーラビリティ活用

### 4.2 垂直スケーリング

- インスタンスサイズの最適化
- メモリ割り当ての調整
- CPU リソースの調整

### 4.3 パフォーマンス最適化

- CDN の活用
- キャッシュ戦略
- データベースインデックス
- クエリ最適化

## 5. 監視・運用

### 5.1 監視項目

- **インフラ監視**

  - CPU 使用率
  - メモリ使用率
  - ディスク使用率
  - ネットワークトラフィック

- **アプリケーション監視**

  - レスポンスタイム
  - エラーレート
  - アクティブユーザー数
  - API 呼び出し数

- **ビジネスメトリクス**
  - 予約数
  - キャンセル率
  - ユーザー登録数
  - 売上推移

### 5.2 アラート設定

- **重大度: Critical**

  - サービス停止
  - エラーレート閾値超過
  - セキュリティ違反

- **重大度: Warning**
  - リソース使用率高
  - レスポンスタイム低下
  - キャッシュヒット率低下

### 5.3 バックアップ戦略

- **データベース**

  - 方式: スナップショット
  - 頻度: 日次
  - 保持期間: 30 日

- **アプリケーション設定**
  - 方式: GitOps
  - 頻度: 変更時
  - 保持: 永続

## 6. 災害対策

### 6.1 バックアップサイト

- Region: asia-northeast2
- 切り替え方式: 自動
- RPO: 24 時間
- RTO: 1 時間

### 6.2 障害復旧手順

1. 障害検知
2. 影響範囲特定
3. バックアップサイト起動
4. DNS フェイルオーバー
5. 動作確認
6. ユーザー通知

### 6.3 定期テスト

- 障害復旧訓練: 四半期ごと
- バックアップ復元テスト: 月次
- セキュリティテスト: 半年ごと
