# 受付順番管理システム 基本設計書

## 目次

1. [システム全体のアーキテクチャ](#1.-システム全体のアーキテクチャ)
2. [ディレクトリ構成](#2.-ディレクトリ構成)
3. [データモデル設計](#3.-データモデル設計)
4. [API エンドポイント設計](#4.-apiエンドポイント設計)
5. [通知システム設計](#5.-通知システム設計)
6. [セキュリティ設計](#6.-セキュリティ設計)
7. [性能要件対応](#7.-性能要件対応)

## 1. システム全体のアーキテクチャ

- フロントエンド：React + TypeScript
- バックエンド：FastAPI
- データベース：
  - 開発環境：Firebase
  - 本番環境：Firebase
- 認証：Firebase Authentication
- 通知：
  - LINE Messaging API

## 2. ディレクトリ構成

```
backend/
├── app/
│   ├── api/
│   │   └── v1/
│   │       ├── endpoints/
│   │       │   ├── __init__.py
│   │       │   ├── auth.py      # 認証関連のエンドポイント
│   │       │   ├── users.py     # ユーザー管理のエンドポイント
│   │       │   └── reservations.py  # 予約管理のエンドポイント
│   │
│   ├── core/
│   │   ├── __init__.py
│   │   ├── config.py     # アプリケーション設定（環境変数、定数など）
│   │   ├── firebase.py   # Firebase初期化と共通機能
│   │   └── security.py   # 認証・認可に関する共通機能
│   │
│   ├── crud/
│   │   ├── __init__.py
│   │   ├── crud_user.py       # ユーザーのCRUD操作
│   │   └── crud_reservation.py # 予約のCRUD操作
│   │
│   ├── models/
│   │   ├── __init__.py
│   │   ├── user.py        # ユーザーのPydanticモデル
│   │   └── reservation.py # 予約のPydanticモデル
│   │
│   └── main.py  # アプリケーションのエントリーポイント
│
├── tests/       # テストコード
│   ├── __init__.py
│   └── conftest.py
│
├── .env         # 環境変数ファイル
├── requirements.txt  # 依存パッケージリスト
└── Dockerfile   # コンテナ化設定
```

1. app/: アプリケーションのメインディレクトリ
   - api/: API エンドポイントの定義
     - v1/: API バージョン 1 のエンドポイント
     - endpoints/: 各機能のエンドポイント実装
   - core/: アプリケーションの中核機能
     - config.py: 環境設定管理
     - firebase.py: Firebase 関連の初期化と共通機能
     - security.py: 認証・認可の共通機能
   - crud/: データベース操作ロジック
     - crud_user.py: ユーザー関連のデータベース操作
     - crud_reservation.py: 予約関連のデータベース操作
   - models/: データモデル定義
     - user.py: ユーザー関連の Pydantic モデル
     - reservation.py: 予約関連の Pydantic モデル
2. tests/: テストコード
   - 単体テスト、統合テストの実装
   - テスト用の設定やフィクスチャ
3. ルートディレクトリ: - .env: 環境変数設定 - requirements.txt: Python パッケージの依存関係 - Dockerfile: コンテナ化設定
   この構成の特徴：
4. 関心の分離: - API エンドポイント（api/） - ビジネスロジック（crud/） - データモデル（models/） - 共通機能（core/）
   が明確に分離されています
5. スケーラビリティ:
   - API バージョニング（v1/）により、将来の API 変更に対応可能
   - 各機能ごとにモジュールが分離されており、新機能の追加が容易
6. メンテナンス性:
   - 機能ごとにファイルが分離されており、コードの管理が容易
   - 共通機能が集約されており、重複コードを防止
7. テスト容易性: - 独立したテストディレクトリにより、テストコードの管理が容易
   モジュール化された構造により、単体テストが書きやすい
   この構成は、FastAPI のベストプラクティスに従っており、小規模から中規模のアプリケーションに適した構造となっています。

## 3. データモデル設計

### データモデルとデータベース設計の関係

- このデータモデルは API インターフェース用の Pydantic モデルです
- 実際のデータベース実装の詳細は「データベース設計書」を参照してください

### API モデルとの対応

- これらのインターフェースは「基本設計書」の Pydantic モデルと対応しています
- API レイヤーでの変換処理は別途実装されます

### 企業モデル

```python
class Company(BaseModel):
    id: str
    company_name: str
    email: str
    phone: str
    created_at: datetime    updated_at: datetime

    class Config:
        schema_extra = {
            "required": ["company_name"]
        }
```

### 店舗モデル

```python
class Store(BaseModel):
    id: str                  # Primary Key
    company_id: str          # Required, Foreign Key -> Company
    store_name: str
    email: str
    phone: str
    created_at: datetime
    updated_at: datetime

    class Config:
        schema_extra = {
            "required": ["store_name", "company_id"]
        }
```

### 受付モデル

```python
class Reception(BaseModel):
    id: str                  # Primary Key
    company_id: str          # Required, Foreign Key -> Company
    store_id: str           # Required, Foreign Key -> Store
    user_id: str            # Required, Foreign Key -> User
    number: int             # 受付番号
    status: str             # 待機中/対応中/完了/キャンセル
    estimated_time: int     # 推定待ち時間（分）
    created_at: datetime
    updated_at: datetime

    class Config:
        schema_extra = {
            "required": ["company_id", "store_id", "user_id", "number"]
        }
```

### ユーザーモデル

```python
class User(BaseModel):
    id: str                  # Primary Key
    company_id: str          # Required, Foreign Key -> Company
    store_id: str           # Required, Foreign Key -> Store
    role: str               # system_admin/company_admin/store_admin/staff/user
    user_name: str
    email: str
    created_at: datetime
    updated_at: datetime

    class Config:
        schema_extra = {
            "required": ["company_id", "store_id", "role", "user_name"]
        }
```

## 4. API エンドポイント設計

### 認証関連

```python
@router.post("/auth/login")
@router.post("/auth/logout")
@router.post("/auth/refresh")
```

### 受付関連

```python
@router.get("/receptions")          # 受付一覧取得
@router.post("/receptions")         # 新規受付発行
@router.get("/receptions/{id}")     # 受付詳細取得
@router.put("/receptions/{id}")     # 受付状態更新
@router.delete("/receptions/{id}")  # 受付キャンセル
@router.get("/receptions/current")  # 現在対応中の番号取得
@router.get("/receptions/waiting")  # 待ち人数・時間取得
```

### 店舗関連

```python
@router.get("/stores")
@router.get("/stores/{id}")
@router.get("/stores/{id}/status")  # 店舗の現在の受付状況
```

## 5. 通知システム設計

### 通知インターフェース

```python
class NotificationService(ABC):
    @abstractmethod
    async def send_approaching_notification(self, reception: Reception):
        """順番接近通知"""
        pass

    @abstractmethod
    async def send_call_notification(self, reception: Reception):
        """呼び出し通知"""
        pass
```

### LINE 通知実装

```python
class LineNotification(NotificationService):
    async def send_approaching_notification(self, reception: Reception):
        # LINE Messaging API実装
        pass
```

## 6. セキュリティ設計

### 認証・認可

- Firebase Authentication による認証
- JWT トークンによる API 認証
- ロールベースアクセス制御（RBAC）の実装

### セキュリティ対策

- CORS 設定による許可オリジン制限
- 環境変数による機密情報管理
- XSS 対策と CSRF 対策
- SQL インジェクション対策

### アクセス制御ミドルウェア

```python
class AccessControlMiddleware:
    async def __call__(self, request: Request, call_next):
        # トークンからユーザー情報取得
        user = await get_current_user(request)

        # 企業・店舗レベルのアクセス制御
        if not await validate_access(user, request):
            raise HTTPException(status_code=403)

        # ロールベースの権限チェック
        if not await validate_role_permission(user, request):
            raise HTTPException(status_code=403)

        return await call_next(request)
```

### 権限管理設計

#### 1. ユーザーロール定義

- system_admin（システム管理者）
  - すべての機能へのアクセス権限
  - システム全体の設定変更権限
  - 全企業・店舗のデータアクセス権限
- company_admin（企業管理者）
  - 自社の全店舗の管理権限
  - 店舗の追加・削除権限
  - 店舗管理者のアサイン権限
  - 自社の統計データ閲覧権限
- store_admin（店舗管理者）
  - 担当店舗の設定変更権限
  - スタッフ管理権限
  - 店舗の統計データ閲覧権限
- staff（店舗スタッフ）
  - 受付番号発行権限
  - 順番管理権限
  - 顧客対応状況更新権限
- user（一般ユーザー）
  - 自身の受付番号確認権限
  - 待ち時間確認権限
  - 順番状況閲覧権限
  - 自身の順番のキャンセル権限

#### 2. 権限チェック実装

```python
class PermissionChecker:
    @staticmethod
    async def check_permission(user: User, required_role: str, resource_id: str = None) -> bool:
        # ロールに基づく権限チェック
        if user.role == "system_admin":
            return True

        if user.role == "company_admin":
            return await validate_company_access(user, resource_id)

        if user.role == "store_admin":
            return await validate_store_access(user, resource_id)

        if user.role == "staff":
            return await validate_staff_access(user, resource_id)

        return await validate_user_access(user, resource_id)
```

#### 3. アクセス制御マトリックス

| 機能             | system_admin | company_admin | store_admin | staff | user |
| ---------------- | ------------ | ------------- | ----------- | ----- | ---- |
| システム設定変更 | ✓            | ×             | ×           | ×     | ×    |
| 企業情報管理     | ✓            | ✓             | ×           | ×     | ×    |
| 店舗管理         | ✓            | ✓             | △\*         | ×     | ×    |
| スタッフ管理     | ✓            | ✓             | ✓           | ×     | ×    |
| 受付管理         | ✓            | ✓             | ✓           | ✓     | ×    |
| 順番確認         | ✓            | ✓             | ✓           | ✓     | ✓    |
| 申込             | ✓            | ✓             | ✓           | ✓     | ✓    |

\*△: 自店舗のみ

## 7. 性能要件対応

### パフォーマンス最適化

- キャッシュ戦略の実装
  - 受付状況のリアルタイム更新
  - 待ち時間計算のキャッシュ
- データベースインデックスの設定
  - 店舗 ID + 状態によるインデックス
  - 受付番号によるインデックス
- WebSocket によるリアルタイム更新
  - 受付状況の即時反映
  - 待ち時間の動的更新

### UI/UX 最適化

- レスポンシブデザイン
- エラーハンドリング
- ローディング表示
