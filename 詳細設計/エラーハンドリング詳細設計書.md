# エラーハンドリング詳細設計書

## 1. エラー体系

### エラーカテゴリ

1. **クライアントエラー（4xx）**

   ```json
   {
     "error": {
       "code": "ERROR_CODE",
       "message": "ユーザー向けエラーメッセージ",
       "details": {
         "field_name": "エラーの詳細情報"
       },
       "trace_id": "エラー追跡用ID"
     }
   }
   ```

2. **サーバーエラー（5xx）**
   ```json
   {
     "error": {
       "code": "ERROR_CODE",
       "message": "システムエラーが発生しました",
       "trace_id": "エラー追跡用ID"
     }
   }
   ```

### エラーコード体系

```
[Domain][Category][Specific]
例：
AUTH_INVALID_CREDENTIALS
USER_NOT_FOUND
RESERVATION_SLOT_UNAVAILABLE
```

#### ドメイン一覧

- `AUTH`: 認証関連
- `USER`: ユーザー管理関連
- `RESERVATION`: 予約関連
- `SYSTEM`: システム全般
- `VALIDATION`: 入力検証関連

## 2. 詳細エラーコード定義

### 認証関連（AUTH）

```json
{
  "AUTH_INVALID_CREDENTIALS": {
    "status": 401,
    "message": "メールアドレスまたはパスワードが正しくありません",
    "log_level": "INFO"
  },
  "AUTH_TOKEN_EXPIRED": {
    "status": 401,
    "message": "認証の有効期限が切れています",
    "log_level": "INFO"
  },
  "AUTH_TOKEN_INVALID": {
    "status": 401,
    "message": "無効な認証トークンです",
    "log_level": "WARN"
  },
  "AUTH_INSUFFICIENT_PERMISSIONS": {
    "status": 403,
    "message": "この操作を行う権限がありません",
    "log_level": "WARN"
  }
}
```

### ユーザー関連（USER）

```json
{
  "USER_NOT_FOUND": {
    "status": 404,
    "message": "ユーザーが見つかりません",
    "log_level": "INFO"
  },
  "USER_EMAIL_EXISTS": {
    "status": 409,
    "message": "このメールアドレスは既に使用されています",
    "log_level": "INFO"
  },
  "USER_INVALID_STATUS": {
    "status": 400,
    "message": "無効なユーザーステータスです",
    "log_level": "WARN"
  }
}
```

### 予約関連（RESERVATION）

```json
{
  "RESERVATION_NOT_FOUND": {
    "status": 404,
    "message": "予約が見つかりません",
    "log_level": "INFO"
  },
  "RESERVATION_SLOT_UNAVAILABLE": {
    "status": 409,
    "message": "指定された時間枠は既に予約されています",
    "log_level": "INFO"
  },
  "RESERVATION_CANCEL_DEADLINE": {
    "status": 400,
    "message": "キャンセル可能期限を過ぎています",
    "log_level": "INFO"
  }
}
```

## 3. エラーハンドリング実装

### グローバルエラーハンドラー

```python
@app.exception_handler(Exception)
async def global_exception_handler(request: Request, exc: Exception):
    trace_id = generate_trace_id()

    # 予期せぬエラーの場合
    if isinstance(exc, Exception) and not isinstance(exc, HTTPException):
        log_error(exc, trace_id)
        return JSONResponse(
            status_code=500,
            content={
                "error": {
                    "code": "SYSTEM_INTERNAL_ERROR",
                    "message": "システムエラーが発生しました",
                    "trace_id": trace_id
                }
            }
        )
```

### バリデーションエラーハンドラー

```python
@app.exception_handler(RequestValidationError)
async def validation_exception_handler(request: Request, exc: RequestValidationError):
    return JSONResponse(
        status_code=422,
        content={
            "error": {
                "code": "VALIDATION_ERROR",
                "message": "入力内容に誤りがあります",
                "details": format_validation_errors(exc.errors())
            }
        }
    )
```

## 4. リトライポリシー

### 自動リトライ対象

1. **ネットワークエラー**

   - 最大リトライ回数: 3 回
   - リトライ間隔: 指数バックオフ（1 秒、2 秒、4 秒）

2. **一時的なサービス障害**
   - 最大リトライ回数: 2 回
   - リトライ間隔: 2 秒

### リトライ非対象

- バリデーションエラー
- 認証エラー
- リソース競合エラー
- ビジネスロジックエラー

## 5. エラーログ記録

### ログレベル判定基準

- `ERROR`: システムエラー、重大な問題
- `WARN`: 潜在的な問題、異常な動作
- `INFO`: 一般的なエラー（認証失敗など）
- `DEBUG`: デバッグ用詳細情報

### ログ記録項目

```json
{
  "timestamp": "ISO8601形式の時刻",
  "trace_id": "エラー追跡ID",
  "error_code": "エラーコード",
  "level": "ログレベル",
  "message": "エラーメッセージ",
  "stack_trace": "スタックトレース（DEBUGレベルのみ）",
  "request": {
    "method": "HTTPメソッド",
    "path": "リクエストパス",
    "headers": "関連ヘッダー"
  },
  "user_id": "ユーザーID（認証済みの場合）"
}
```

## 6. 監視・アラート

### アラート条件

1. **即時アラート**

   - 5xx エラーが 1 分間に 10 回以上発生
   - 特定の API の失敗率が 20%を超過
   - クリティカルなシステムエラー

2. **集計アラート**
   - 特定のエラーコードの急増
   - 平均レスポンスタイムの悪化
   - リトライ回数の増加

### アラート方法

- Slack 通知
- メール通知（重大エラーの場合）
- 監視ダッシュボード更新
