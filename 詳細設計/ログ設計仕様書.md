# ログ設計仕様書

## 1. ログレベル定義

### ERROR

- 重大度：最高
- 用途：即時対応が必要な重大な問題
- 記録対象：
  - システムクラッシュ
  - データベース接続エラー
  - 重要な業務処理の失敗
  - セキュリティ違反
- 通知：即時アラート（Slack + メール）

### WARN

- 重大度：高
- 用途：潜在的な問題や異常の検知
- 記録対象：
  - リトライ発生
  - パフォーマンス低下
  - 認証失敗の連続発生
  - API 呼び出しの遅延
- 通知：状況に応じて Slack 通知

### INFO

- 重大度：中
- 用途：重要な業務イベントの記録
- 記録対象：
  - ユーザーログイン/ログアウト
  - 予約作成/変更/キャンセル
  - バッチ処理の開始/終了
  - システム起動/停止
- 通知：なし

### DEBUG

- 重大度：低
- 用途：開発時のデバッグ情報
- 記録対象：
  - 関数の入出力値
  - 詳細な処理フロー
  - SQL 文
  - API リクエスト/レスポンス
- 通知：なし

## 2. ログフォーマット

### 基本フォーマット

```json
{
  "timestamp": "ISO8601形式の時刻",
  "level": "ログレベル",
  "trace_id": "リクエストの追跡ID",
  "service": "サービス名",
  "environment": "環境名",
  "message": "ログメッセージ",
  "context": {
    "user_id": "ユーザーID（該当する場合）",
    "request_id": "リクエストID",
    "path": "APIパス",
    "method": "HTTPメソッド",
    "ip": "クライアントIP"
  },
  "additional_info": {
    // コンテキストに応じた追加情報
  }
}
```

### リクエストログ

```json
{
  "type": "request",
  "request": {
    "headers": "関連ヘッダー情報",
    "body": "リクエストボディ（機密情報は除く）",
    "query_params": "クエリパラメータ"
  }
}
```

### レスポンスログ

```json
{
  "type": "response",
  "response": {
    "status_code": "HTTPステータスコード",
    "body": "レスポンスボディ（機密情報は除く）",
    "processing_time": "処理時間（ミリ秒）"
  }
}
```

## 3. ログ出力先と保存期間

### アプリケーションログ

- 出力先：`/logs/app/`
- ファイル名：`app-{YYYY-MM-DD}.log`
- 保存期間：90 日
- ローテーション：日次

### アクセスログ

- 出力先：`/logs/access/`
- ファイル名：`access-{YYYY-MM-DD}.log`
- 保存期間：30 日
- ローテーション：日次

### エラーログ

- 出力先：`/logs/error/`
- ファイル名：`error-{YYYY-MM-DD}.log`
- 保存期間：180 日
- ローテーション：日次

### セキュリティログ

- 出力先：`/logs/security/`
- ファイル名：`security-{YYYY-MM-DD}.log`
- 保存期間：365 日
- ローテーション：日次

## 4. ログローテーション設定

### ローテーション条件

- 時間ベース：毎日 0 時
- サイズベース：ファイルサイズが 1GB 超過時
- 保存世代数：設定された保存期間に応じる

### 圧縮設定

- 形式：gzip
- タイミング：ローテーション時
- ファイル名：`{original_name}.gz`

## 5. 監視・アラート設定

### リアルタイム監視

1. エラーログ監視

   - ERROR レベルのログ発生
   - WARN レベルログの急増
   - 特定のエラーパターンの検出

2. パフォーマンス監視

   - レスポンスタイム閾値超過
   - リソース使用率の監視
   - API コール数の監視

3. セキュリティ監視
   - 認証失敗の連続発生
   - 不正アクセスパターンの検出
   - 重要操作の監視

### アラート条件

1. 即時アラート（Slack + メール）

   - ERROR レベルのログ発生
   - セキュリティインシデントの検知
   - システムクリティカルエラー

2. 集計アラート（Slack）
   - WARN レベルログが 10 分間で 100 件超過
   - 特定 API のエラー率が 10%超過
   - レスポンスタイムが基準値の 2 倍超過

### レポート生成

- 日次レポート：基本的な統計情報
- 週次レポート：詳細な分析とトレンド
- 月次レポート：長期的な傾向分析

## 6. セキュリティ考慮事項

### 機密情報の扱い

- パスワード：完全に除外
- トークン：ハッシュ化して記録
- 個人情報：マスキング処理
- クレジットカード情報：完全に除外

### アクセス制御

- ログファイルへのアクセス権限設定
- 監視ダッシュボードのアクセス制御
- ログ参照 API の権限管理

### 暗号化

- 転送時の暗号化（TLS）
- 保存時の暗号化（必要に応じて）


